<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>USCIS 100 Câu — Trang 3/5</title>
<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; line-height:1.6; margin:0; padding:0; background:#f7f7f9; }
  header { background:#0f172a; color:#fff; padding:24px; }
  main { max-width: 900px; margin: 0 auto; padding: 24px; }
  .card { background:#fff; border-radius:16px; box-shadow: 0 10px 20px rgba(0,0,0,.06); padding:20px; margin-bottom:16px; }
  .q-title { font-weight:700; margin-bottom:8px; }
  .meta { color:#475569; font-size:14px; margin-bottom:16px; }
  .choices label { display:block; margin:8px 0; padding:10px 12px; border:1px solid #e2e8f0; border-radius:12px; cursor:pointer; }
  .choices input { margin-right:8px; }
  .correct { border-color:#16a34a !important; background:#f0fdf4; }
  .wrong { border-color:#dc2626 !important; background:#fef2f2; }
  .footer { display:flex; gap:12px; flex-wrap:wrap; margin-top:16px; }
  button { border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer; }
  .primary { background:#2563eb; color:#fff; }
  .ghost { background:#e2e8f0; }
  .badge { display:inline-block; background:#e2e8f0; border-radius:999px; padding:4px 10px; font-size:12px; color:#334155; }
</style>
</head>
<body>
<header>
  <h1 style="margin:0">USCIS 100 Câu — Trang 1/5</h1>
  <p class="meta" style="margin-top:6px">Mỗi trang 20 câu. Nộp trang để lưu điểm vào “Kết quả”.</p>
</header>
<main>
  <div class="card">
    <div class="meta">Page progress: <span id="score" class="badge">0</span></div>
    <div id="saved-badge" class="badge">Not saved</div>
    <div class="footer">
      <a class="ghost" id="prev" href="#" style="text-decoration:none;display:none;">◀ Trang trước</a>
      <a class="ghost" id="next" href="#" style="text-decoration:none;">Trang sau ▶</a>
      <button class="primary" id="btn-submit">Submit this page</button>
      <button class="ghost" id="btn-clear">Clear selections</button>
      <button class="ghost" id="btn-results">View Results</button>
    </div>
  </div>
  <div id="quiz"></div>
  <div class="card">
    <div class="footer">
      <a class="ghost" id="prev2" href="#" style="text-decoration:none;display:none;">◀ Trang trước</a>
      <a class="ghost" id="next2" href="#" style="text-decoration:none;">Trang sau ▶</a>
      <button class="primary" id="btn-submit2">Submit this page</button>
      <button class="ghost" id="btn-clear2">Clear selections</button>
      <button class="ghost" id="btn-results2">View Results</button>
    </div>
  </div>
</main>
<script>
const PAGE_NUM = 3; // <<< CHANGE THIS to 1..5 for each page
const STORAGE_KEY = "uscis_vi_2008_quiz_full";

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return { pages: {} };
  try { return JSON.parse(raw); } catch(e){ return { pages: {} }; }
}
function saveState(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }

function buildPool(dataset){
  const pool = [];
  dataset.questions.forEach(q => {
    const a = (q.answers && q.answers.length) ? q.answers[0].trim() : null;
    if (a && a.length <= 120) pool.push(a);
  });
  return Array.from(new Set(pool));
}
function makeChoices(correct, pool, k=3){
  const candidates = pool.filter(p => p !== correct);
  for (let i = candidates.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
  }
  const distractors = [];
  for (const c of candidates){
    const cl = c.toLowerCase(), rl = correct.toLowerCase();
    if (cl === rl) continue;
    if (cl.includes(rl) || rl.includes(cl)) continue;
    distractors.push(c);
    if (distractors.length >= k) break;
  }
  const generic = ["Tôi không biết", "Không áp dụng", "Không có đáp án nào đúng"];
  for (const g of generic){
    if (distractors.length >= k) break;
    if (g !== correct && !distractors.includes(g)) distractors.push(g);
  }
  const opts = [correct, ...distractors.slice(0,k)];
  for (let i = opts.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [opts[i], opts[j]] = [opts[j], opts[i]]; }
  const answer_index = opts.indexOf(correct);
  return {opts, answer_index};
}

let QUIZ_DATA = null;
let POOL = null;
let QUESTIONS = null;
const CHOICES = {};
let answers = [];
let submitted = false;

function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else e.setAttribute(k,v);
  }
  for(const c of [].concat(children)) e.appendChild(c);
  return e;
}
function render(){
  const root = document.getElementById("quiz");
  root.innerHTML = "";
  QUESTIONS.forEach((q, i)=>{
    const card = el("div", {class:"card"});
    const title = el("div", {class:"q-title", html: `${(PAGE_NUM-1)*20 + i + 1}. ${q.question}`});
    const correct = (q.answers && q.answers.length) ? q.answers[0] : "";
    if (!CHOICES[i]){
      const built = makeChoices(correct, POOL, 3);
      CHOICES[i] = { choices: built.opts, answer_index: built.answer_index };
    }
    const choices = el("div", {class:"choices"});
    CHOICES[i].choices.forEach((ch, j)=>{
      const lbl = el("label");
      const inp = el("input", {type:"radio", name:`q_${i}`});
      if(answers[i]===j) inp.checked = true;
      inp.addEventListener("change", ()=>{ answers[i]=j; updateScorePreview(); });
      lbl.appendChild(inp);
      lbl.appendChild(el("span", {html: ch}));
      if(submitted){
        const isCorrect = j===CHOICES[i].answer_index;
        const isSelected = answers[i]===j;
        if(isCorrect) lbl.classList.add("correct");
        if(isSelected && !isCorrect) lbl.classList.add("wrong");
      }
      choices.appendChild(lbl);
    });
    card.appendChild(title);
    card.appendChild(choices);
    root.appendChild(card);
  });
  updateScorePreview();
}
function updateScorePreview(){
  const sc = document.getElementById("score");
  let correct = 0;
  for(let i=0;i<QUESTIONS.length;i++){ if(answers[i]===CHOICES[i].answer_index) correct++; }
  const done = answers.filter(a=>a!==null).length;
  sc.textContent = `Selected: ${done} / ${QUESTIONS.length} — If submit now: ${correct} / ${QUESTIONS.length}`;
}
function submitPage(){
  submitted = true;
  let correct = 0;
  for(let i=0;i<QUESTIONS.length;i++){ if(answers[i]===CHOICES[i].answer_index) correct++; }
  const st = loadState();
  st.pages[PAGE_NUM] = { score: correct, total: QUESTIONS.length, answers };
  saveState(st);
  render();
  document.getElementById("saved-badge").textContent = `Saved: Page ${PAGE_NUM} — ${correct} / ${QUESTIONS.length}`;
}
function clearSelections(){ answers = Array(QUESTIONS.length).fill(null); submitted = false; render(); }
function loadExisting(){
  const st = loadState();
  const p = st.pages[PAGE_NUM];
  if(p){ answers = p.answers || answers; submitted = true; }
}

function setupNav(){
  const prev = document.getElementById("prev");
  const next = document.getElementById("next");
  const prev2 = document.getElementById("prev2");
  const next2 = document.getElementById("next2");
  if(PAGE_NUM>1){ prev.style.display = prev2.style.display = "inline-block"; prev.href = prev2.href = `page${PAGE_NUM-1}.html`; }
  if(PAGE_NUM<5){ next.href = next2.href = `page${PAGE_NUM+1}.html`; } else { next.style.display = next2.style.display = "none"; }
}

document.getElementById("btn-submit").addEventListener("click", submitPage);
document.getElementById("btn-submit2").addEventListener("click", submitPage);
document.getElementById("btn-clear").addEventListener("click", clearSelections);
document.getElementById("btn-clear2").addEventListener("click", clearSelections);
document.getElementById("btn-results").addEventListener("click", ()=>{ window.location.href = "results.html"; });
document.getElementById("btn-results2").addEventListener("click", ()=>{ window.location.href = "results.html"; });

fetch("./data/questions_vi.json")
  .then(r => r.json())
  .then(data => {
    QUIZ_DATA = data;
    POOL = buildPool(data);
    const start = (PAGE_NUM-1)*20;
    QUESTIONS = data.questions.slice(start, start+20);
    answers = Array(QUESTIONS.length).fill(null);
    setupNav();
    loadExisting();
    render();
  })
  .catch(err => {
    document.getElementById("quiz").innerHTML = "<div class='card'>Không tải được dữ liệu câu hỏi. Hãy kiểm tra file <code>data/questions_vi.json</code>.</div>";
    console.error(err);
  });
</script>
</body>
</html>
